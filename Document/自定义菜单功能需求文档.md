# 自定义菜单功能需求文档

## 1. 功能概述

为"发送到AI"脚本新增自定义菜单功能，允许用户通过配置文件定义多个预设的文本处理菜单项，通过快捷键Win+F3显示菜单，并支持鼠标点击或键盘快捷键触发对应的文本处理流程。

## 2. 使用流程

1. 用户在Config.ini配置文件中新增多个自定义菜单项配置
2. 按下Win+F3快捷键，显示包含所有配置菜单项的UI菜单
3. 用户通过以下两种方式之一触发对应的文本处理流程：
   - 鼠标点击菜单项
   - 键盘按下数字键1、2、3等（对应菜单项序号）

## 3. 配置文件结构

### 3.1 新增配置节

在Config.ini中新增以下配置节：

```
[MenuSettings]
MenuCount=3  ; 菜单项总数

[MenuItem1]
Name=翻译为英语
Content=翻译为英语：{text}
NewChat=1
SendEnter=1

[MenuItem2]
Name=总结要点
Content=请总结以下内容的要点：{text}
NewChat=0
SendEnter=1

[MenuItem3]
Name=代码解释
Content=解释以下代码的功能：{text}
NewChat=1
SendEnter=0
```

### 3.2 配置项说明

每个菜单项包含以下配置：

| 配置项 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Name | 字符串 | 是 | 显示在菜单中的名称 |
| Content | 字符串 | 否 | 发送内容模板，支持{text}变量 |
| NewChat | 布尔值 | 是 | 是否新建对话（1=开，0=关） |
| SendEnter | 布尔值 | 是 | 是否发送回车（1=开，0=关） |

## 4. 功能详细说明

### 4.1 菜单显示功能

- 触发方式：Win+F3
- 显示内容：所有配置的菜单项名称
- 显示方式：弹出式菜单，支持鼠标点击和键盘快捷键
- 键盘快捷键：数字键1-9对应前9个菜单项

### 4.2 文本处理流程

#### 4.2.1 内容拼接规则

- 如果Content配置为空，则使用当前剪贴板内容直接发送
- 如果Content配置不为空，则进行内容拼接：
  - {text}变量会被替换为当前剪贴板内容
  - 拼接后的内容会复制到剪贴板
  - 示例：剪贴板内容为"小狗"，Content为"翻译为英语：{text}"，拼接后为"翻译为英语：小狗"

#### 4.2.2 执行流程

根据NewChat和SendEnter配置，执行不同的流程：

1. **复制选中内容**
   - 执行Ctrl+C复制当前选中内容到剪贴板

2. **内容拼接**
   - 如果Content不为空，进行内容拼接并更新剪贴板
   - 如果Content为空，保持剪贴板内容不变

3. **激活应用**
   - 激活当前配置的AI应用

4. **按键操作**
   - 如果NewChat=1，执行Ctrl+K
   - 执行Ctrl+M
   - 执行Ctrl+V粘贴内容
   - 如果SendEnter=1，执行Enter键

### 4.3 流程示例

#### 示例1：翻译功能（NewChat=1, SendEnter=1）
```
复制选中内容 -> 拼接发送内容 -> 激活应用 -> Ctrl+K -> Ctrl+M -> 粘贴 -> 回车
```

#### 示例2：追加内容（NewChat=0, SendEnter=0）
```
复制选中内容 -> 拼接发送内容 -> 激活应用 -> Ctrl+M -> 粘贴
```

## 5. 技术实现要点

### 5.1 配置文件读取

- 需要新增读取MenuSettings和MenuItem配置的函数
- 支持UTF-8编码读取配置文件
- 提供默认值处理机制

### 5.2 菜单UI实现

- 使用AutoHotkey的Menu对象创建菜单
- 支持键盘快捷键绑定
- 提供菜单项序号显示

### 5.3 文本处理

- 实现{text}变量替换功能
- 处理空Content配置的情况
- 确保剪贴板操作的正确性

### 5.4 流程控制

- 根据配置动态决定是否执行Ctrl+K和Enter
- 保持与现有功能的兼容性
- 提供错误处理机制

## 6. 兼容性考虑

- 保持现有Win+F1、Win+F2和Win+F10功能不变
- 确保配置文件向后兼容
- 菜单功能不影响现有配置的读取和使用

## 7. 扩展性考虑

- 支持未来添加更多菜单项配置选项
- 考虑支持子菜单的可能性
- 预留菜单项图标等扩展功能的接口

## 8. 测试要点

- 测试不同Content配置的文本拼接功能
- 测试NewChat和SendEnter的各种组合
- 测试键盘快捷键和鼠标点击的一致性
- 测试配置文件不存在或格式错误的情况
- 测试与现有功能的兼容性